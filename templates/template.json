{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Master Stack for AtomikLabs Infrastructure Definitions",
    "Parameters": {
        "EnvironmentName": {
            "Type": "String",
            "Description": "The name of the environment",
            "Default": "dev",
            "AllowedValues": ["test", "dev", "stage", "prod"]
        },
        "NetworkingSubstackTemplateURL": { "Type": "String", "Description": "S3 URL of the networking stack template" },
        "VpcCidr": { "Type": "String", "Description": "The CIDR block for the VPC", "Default": "10.0.0.0/16" },
        "PublicSubnet1Cidr": {
            "Type": "String",
            "Description": "The CIDR block for the public subnet 1",
            "Default": "10.0.1.0/24"
        },
        "PublicSubnet2Cidr": {
            "Type": "String",
            "Description": "The CIDR block for the public subnet 2",
            "Default": "10.0.2.0/24"
        },
        "PrivateSubnet1Cidr": {
            "Type": "String",
            "Description": "The CIDR block for the private subnet 1",
            "Default": "10.0.101.0/24"
        },
        "PrivateSubnet2Cidr": {
            "Type": "String",
            "Description": "The CIDR block for the private subnet 2",
            "Default": "10.0.102.0/24"
        },
        "DataLayerSubstackTemplateURL": {
            "Type": "String",
            "Description": "S3 URL of the networking stack template"
        },
        "BastionHostPermittedCidr": {
            "Type": "String",
            "Description": "The CIDR block for the bastion host",
            "Default": ""
        }
    },
    "Resources": {
        "NetworkingSubstack": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "TemplateURL": { "Ref": "NetworkingSubstackTemplateURL" },
                "Parameters": {
                    "EnvironmentName": { "Ref": "EnvironmentName" },
                    "VpcCidr": { "Ref": "VpcCidr" },
                    "PublicSubnet1Cidr": { "Ref": "PublicSubnet1Cidr" },
                    "PublicSubnet2Cidr": { "Ref": "PublicSubnet2Cidr" },
                    "PrivateSubnet1Cidr": { "Ref": "PrivateSubnet1Cidr" },
                    "PrivateSubnet2Cidr": { "Ref": "PrivateSubnet2Cidr" },
                    "BastionHostPermittedCidr": { "Ref": "BastionHostPermittedCidr" }
                }
            }
        },
        "DataLayerSubstack": {
            "Type": "AWS::CloudFormation::Stack",
            "Properties": {
                "TemplateURL": { "Ref": "DataLayerSubstackTemplateURL" },
                "Parameters": {
                    "EnvironmentName": { "Ref": "EnvironmentName" },
                    "RDSSecurityGroup": { "Fn::ImportValue": "NetworkingSubstack:RDSSecurityGroup" },
                    "RDSSubnetGroup": { "Fn::ImportValue": "NetworkingSubstack:RDSSubnetGroup" }
                }
            }
        }
    }
}
